# build image command: apptainer build image.sif my_recipe.def
Bootstrap: docker
#From: continuumio/miniconda3
#From: continuumio/miniconda3:latest
From: python:3.8-slim

%setup
    mkdir ${APPTAINER_ROOTFS}/requirement

%files
    ../src .
    ../requirements.txt requirement


%post
    pip install --upgrade pip
    # Update conda
    #conda update -n base -c defaults conda -y
    #apt-get update
    

    # Install Python (if not already included in your base image)
    #conda install -y python=3.8
    #conda install -y python=3.9
    #conda install -y python=3.10
    



    # Explicitly set environment variables to avoid GPU usage
    export CUDA_VISIBLE_DEVICES=""
    export DGLBACKEND=pytorch

    # Reinstall CPU-only versions of the necessary packages
     pip install torch==2.1.2 torchvision torchaudio
     pip uninstall -y dgl
     pip install dgl -f https://data.dgl.ai/wheels/repo.html

    # Install DGLGo if needed (remove if not necessary for your setup)
     pip install dglgo -f https://data.dgl.ai/wheels-test/repo.html


    # Any additional setup can go here
     pip install -r requirement/requirements.txt



     pip install mlflow torch
     pip install lightning
     pip install torchmetrics
     pip install deepspeed
     pip install colorama
     pip install entrypoints







%environment
    export PATH=/opt/conda/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export PATH=/opt/conda/bin:$PATH

    #libcusparse.so.12
    export LD_LIBRARY_PATH=/apps/.skylake/Alvis/software/NVHPC/23.7-CUDA-12.1.1/Linux_x86_64/23.7/REDIST/math_libs/12.2/targets/x86_64-linux/lib:$LD_LIBRARY_PATH
    #libnvJitLink.so.12
    export LD_LIBRARY_PATH=/apps/.skylake/Alvis/software/NVHPC/23.7-CUDA-12.1.1/Linux_x86_64/23.7/cuda/12.2/targets/x86_64-linux/lib:$LD_LIBRARY_PATH
    #export LD_LIBRARY_PATH=/apps/Common/software/CUDA/12.1.1/targets/x86_64-linux/lib:$LD_LIBRARY_PATH


%runscript
    exec python "$@"
